<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PMI ‚Äì Temporizador de Debate Rel√¢mpago</title>
  <style>
    :root { --red: #B22234; }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      background-color: #0b2550;
      background-image: url('logo.png');
      background-repeat: no-repeat;
      background-size: 308px auto;
      background-position: calc(100% - 24px) 20px;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      color: #fff;
      /* removed transition and body.finished rule ‚Äî background never changes */
    }

    /* Confetti canvas overlay */
    #confetti-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 999;
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 50%;
      left: 53px;
      transform: translateY(-50%);
      width: 242px;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .phase-row {
      padding: 8px 12px; border-radius: 6px;
      border-left: 3px solid transparent;
      transition: all 0.3s;
    }
    .phase-row.current {
      background: rgba(255,255,255,0.1);
      border-left-color: #fff;
    }
    .phase-row .pl { font-size: 17px; font-weight: 400; color: #4a6090; line-height: 1.3; }
    .phase-row.current .pl { font-weight: 700; color: #fff; }
    .phase-row .pt { font-size: 14px; color: #334d7a; margin-top: 2px; }
    .phase-row.current .pt { color: #cbd5e1; }

    #main {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #debate-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 572px;
    }

    #phase-label {
      width: 100%;
      text-align: center;
      font-size: 48px; font-weight: 800; color: #fff;
      margin-bottom: 4px;
    }
    #phase-team {
      width: 100%;
      text-align: center;
      font-size: 31px; color: #cbd5e1;
      margin-bottom: 35px;
    }

    /* Ring */
    #ring-wrap {
      position: relative;
      width: 374px; height: 374px;
      margin: 0 auto 44px;
    }
    #ring-svg { transform: rotate(-90deg); }
    #ring-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 15; }
    #ring-fg { fill: none; stroke: #fff; stroke-width: 15; stroke-linecap: round;
               transition: stroke-dashoffset 0.8s linear, stroke 0.3s; }
    #ring-fg.done { stroke: var(--red); }
    #timer-text {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    #timer-digits {
      font-size: 106px; font-weight: 800; color: #fff;
      font-variant-numeric: tabular-nums; line-height: 1;
    }
    #timer-digits.done { color: var(--red); }
    #timer-label {
      font-size: 12px; color: var(--red);
      margin-top: 9px; letter-spacing: 0.12em; display: none;
    }

    /* Interp */
    #interp-wrap {
      width: 374px; height: 374px;
      margin: 0 auto 44px;
      background: rgba(255,255,255,0.05); border-radius: 50%;
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      border: 4px solid var(--red);
    }
    #interp-wrap.response { border-color: #10b981; box-shadow: 0 0 44px #10b98133; }
    #interp-wrap.group    { box-shadow: 0 0 44px #B2223433; }
    #interp-tag   { font-size: 12px; letter-spacing: 0.12em; text-transform: uppercase; color: #94a3b8; margin-bottom: 7px; }
    #interp-who   { font-size: 17px; font-weight: 600; color: var(--red); margin-bottom: 9px; }
    #interp-wrap.response #interp-who { color: #10b981; }
    #interp-digits { font-size: 70px; font-weight: 800; font-variant-numeric: tabular-nums; line-height: 1; }
    #btn-skip {
      margin-top: 15px; padding: 7px 15px;
      background: transparent; border: 1px solid #475569;
      border-radius: 6px; color: #94a3b8; font-size: 13px; cursor: pointer;
    }

    /* Buttons */
    .btn-row {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 22px;
      min-height: 62px;
    }
    #btn-start {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    .btn-row2 {
      display: flex; gap: 13px;
      flex-wrap: wrap; justify-content: center;
    }
    button.ctrl {
      padding: 15px 26px; border-radius: 12px;
      font-size: 17px; font-weight: 700; cursor: pointer;
      min-width: 165px; border: 1px solid rgba(255,255,255,0.15);
      transition: all 0.15s; color: #f1f5f9;
    }
    button.ctrl:disabled {
      background: transparent; border-color: #1e3a6e;
      color: #1e3a6e; cursor: not-allowed;
    }
    #btn-prev, #btn-next, #btn-reset { background: #1e3a6e; }
    #btn-start { background: #fff; color: #0b2550; }
    #btn-start.running { background: #334155; color: #fff; }
    #btn-interp { background: var(--red); color: #fff; }
    #no-interp { font-size: 12px; color: #2d4a7a; padding: 10px 0; }

    /* Finished screen */
    #finished-screen {
      display: none; flex-direction: column;
      align-items: center; text-align: center;
    }
    #finished-screen.visible { display: flex; }

    /* Animated trophy/emoji */
    #fin-emoji {
      font-size: 88px;
      margin-bottom: 13px;
      animation: popBounce 0.6s cubic-bezier(.36,1.56,.64,1) both;
    }
    @keyframes popBounce {
      0%   { transform: scale(0) rotate(-20deg); opacity: 0; }
      60%  { transform: scale(1.25) rotate(6deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    #fin-title {
      font-size: 44px; font-weight: 800; color: #fff;
      margin-bottom: 9px;
      animation: fadeSlideUp 0.5s 0.2s ease both;
    }
    #fin-sub {
      font-size: 17px; color: #cbd5e1;
      margin-bottom: 44px;
      animation: fadeSlideUp 0.5s 0.35s ease both;
    }
    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(18px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    #fin-btns   { display: flex; gap: 13px; justify-content: center;
                  animation: fadeSlideUp 0.5s 0.5s ease both; }
    #btn-applause { background: #1e3a6e; color: #fff; }
    #btn-restart  { background: #1e3a6e; }

    /* Footer */
    #footer {
      position: fixed; bottom: 18px; right: 22px;
      font-size: 12px; color: rgba(255,255,255,0.4);
      letter-spacing: 0.04em; line-height: 1.7;
      user-select: none;
      text-align: right;
    }
  </style>
</head>
<body>

  <canvas id="confetti-canvas"></canvas>

  <div id="footer">
    Projecto Multidisciplinar I<br />
    <span id="clock"></span>
  </div>

  <div id="sidebar"></div>

  <div id="main">
    <div id="debate-view">
      <div id="phase-label"></div>
      <div id="phase-team"></div>

      <div id="ring-wrap">
        <svg id="ring-svg" width="374" height="374">
          <circle id="ring-bg" cx="187" cy="187" r="160" />
          <circle id="ring-fg" cx="187" cy="187" r="160" />
        </svg>
        <div id="timer-text">
          <div id="timer-digits"></div>
          <div id="timer-label">TEMPO ESGOTADO</div>
        </div>
      </div>

      <div id="interp-wrap">
        <div id="interp-tag">Interpela√ß√£o</div>
        <div id="interp-who"></div>
        <div id="interp-digits"></div>
        <button id="btn-skip" onclick="skipInterp()"></button>
      </div>

      <div class="btn-row">
        <button id="btn-prev"  class="ctrl" onclick="goPrev()">‚Üê Fase anterior</button>
        <button id="btn-start" class="ctrl" onclick="toggleRun()">‚ñ∂  Iniciar</button>
        <button id="btn-next"  class="ctrl" onclick="goNext()">Fase seguinte ‚Üí</button>
      </div>
      <div class="btn-row2">
        <button id="btn-interp" class="ctrl" onclick="startInterp()">‚úã Interpela√ß√£o (1 + 1 min)</button>
        <div id="no-interp">Interpela√ß√µes n√£o permitidas nesta fase</div>
        <button id="btn-reset" class="ctrl" onclick="resetDebate()">‚Ü∫ Reiniciar debate</button>
      </div>
    </div>

    <div id="finished-screen">
      <div id="fin-emoji">üèÜ</div>
      <div id="fin-title">Debate conclu√≠do!</div>
      <div id="fin-sub">Bom trabalho a todos os grupos.</div>
      <div id="fin-btns">
        <button id="btn-applause" class="ctrl" onclick="triggerApplause()">üëè Palmas</button>
        <button id="btn-restart"  class="ctrl" onclick="resetDebate()">‚Ü∫ Reiniciar</button>
      </div>
    </div>
  </div>

<script>
/* ‚îÄ‚îÄ Confetti engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
(function(){
  const canvas = document.getElementById("confetti-canvas");
  const ctx = canvas.getContext("2d");
  let particles = [];
  let animId = null;

  function resize() {
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resize);
  resize();

  const COLORS = ["#fff","#fbbf24","#f87171","#34d399","#60a5fa","#c084fc","#fb923c"];

  function spawn(n) {
    for (let i = 0; i < n; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: -10 - Math.random() * 200,
        vx: (Math.random() - 0.5) * 4,
        vy: 2 + Math.random() * 5,
        angle: Math.random() * Math.PI * 2,
        spin: (Math.random() - 0.5) * 0.3,
        w: 8 + Math.random() * 8,
        h: 4 + Math.random() * 4,
        color: COLORS[Math.floor(Math.random() * COLORS.length)],
        alpha: 1,
        decay: 0.008 + Math.random() * 0.006,
      });
    }
  }

  function frame() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles = particles.filter(p => p.alpha > 0);
    for (const p of particles) {
      p.x += p.vx; p.y += p.vy;
      p.vy += 0.12; // gravity
      p.vx *= 0.99;
      p.angle += p.spin;
      p.alpha -= p.decay;
      ctx.save();
      ctx.globalAlpha = Math.max(0, p.alpha);
      ctx.translate(p.x, p.y);
      ctx.rotate(p.angle);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    }
    if (particles.length > 0) animId = requestAnimationFrame(frame);
    else animId = null;
  }

  window.launchConfetti = function(big) {
    spawn(big ? 320 : 180);
    // For big bursts, keep adding waves
    if (big) {
      setTimeout(() => spawn(200), 600);
      setTimeout(() => spawn(180), 1400);
      setTimeout(() => spawn(160), 2400);
    }
    if (!animId) animId = requestAnimationFrame(frame);
  };
})();

/* ‚îÄ‚îÄ Debate logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const PHASES = [
  { label:"Apresenta√ß√£o",  team:"Defesa",   duration:120 },
  { label:"Apresenta√ß√£o",  team:"Oposi√ß√£o",  duration:120 },
  { label:"Confer√™ncia 1", team:"Ambas",    duration:60  },
  { label:"Refuta√ß√£o 1",   team:"Defesa",   duration:120 },
  { label:"Refuta√ß√£o 1",   team:"Oposi√ß√£o", duration:120 },
  { label:"Confer√™ncia 2", team:"Ambas",    duration:60  },
  { label:"Refuta√ß√£o 2",   team:"Defesa",   duration:60  },
  { label:"Refuta√ß√£o 2",   team:"Oposi√ß√£o", duration:60  },
  { label:"Confer√™ncia 3", team:"Ambas",    duration:60  },
  { label:"Conclus√£o",     team:"Defesa",   duration:60  },
  { label:"Conclus√£o",     team:"Oposi√ß√£o", duration:60  },
];
const CIRC = 2 * Math.PI * 160;
const APARTE_DUR = 60;
const NO_INTERP = ["Apresenta√ß√£o","Conclus√£o"];

let phaseIdx   = 0;
let timeLeft   = PHASES[0].duration;
let running    = false;
let done       = false;
// 'pendingFinish': last phase done, gong played, waiting for "Fase seguinte" click
let pendingFinish = false;
let finished   = false;
let interp     = null;
let interpTime = APARTE_DUR;
let mainTimer  = null;
let interpTimer= null;

function playSound(f) { try { new Audio(f).play().catch(()=>{}); } catch(e){} }
function playBell()     { playSound("boxing bell.wav"); }
function playBuzzer()   { playSound("meditation gong.wav"); }
function playApplause() { playSound("applause.wav"); }

// Triggered by the button on the finished screen
function triggerApplause() {
  playApplause();
  launchConfetti(true);
}

function fmt(s) {
  const m = Math.floor(Math.abs(s)/60), sec = Math.abs(s)%60;
  return (m<10?"0":"")+m+":"+(sec<10?"0":"")+sec;
}
function fmtClock(d) {
  const p = n => String(n).padStart(2,"0");
  return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate())
    +" "+p(d.getHours())+":"+p(d.getMinutes())+":"+p(d.getSeconds());
}

setInterval(()=>{ document.getElementById("clock").textContent = fmtClock(new Date()); }, 1000);
document.getElementById("clock").textContent = fmtClock(new Date());

function buildSidebar() {
  const sb = document.getElementById("sidebar"); sb.innerHTML = "";
  PHASES.forEach((p,i) => {
    const d = document.createElement("div");
    d.className = "phase-row"+(i===phaseIdx?" current":"");
    d.innerHTML = `<div class="pl">${p.label}</div><div class="pt">${p.team} ¬∑ ${fmt(p.duration)}</div>`;
    sb.appendChild(d);
  });
}

function updateRing() {
  const ph = PHASES[phaseIdx];
  const fg = document.getElementById("ring-fg");
  fg.setAttribute("stroke-dasharray", CIRC);
  fg.setAttribute("stroke-dashoffset", CIRC * (timeLeft/ph.duration));
  fg.className.baseVal = done ? "done" : "";
  document.getElementById("timer-digits").textContent = fmt(timeLeft);
  document.getElementById("timer-digits").className = done ? "done" : "";
  document.getElementById("timer-label").style.display = done ? "block" : "none";
}

function updateInterpDisplay() {
  const iw = document.getElementById("interp-wrap");
  const rw = document.getElementById("ring-wrap");
  if (interp) {
    iw.style.display = "flex"; rw.style.display = "none";
    iw.className = interp==="group" ? "group" : "response";
    document.getElementById("interp-who").textContent =
      interp==="group" ? "Grupo interpelante fala" : "Equipa responde";
    document.getElementById("interp-digits").textContent = fmt(interpTime);
    document.getElementById("btn-skip").textContent =
      "Saltar ‚Üí "+(interp==="group" ? "resposta" : "retomar");
  } else {
    iw.style.display = "none"; rw.style.display = "block";
  }
}

function updateButtons() {
  const ph = PHASES[phaseIdx];
  const noI = NO_INTERP.includes(ph.label) || ph.team==="Ambas";
  document.getElementById("btn-prev").style.visibility = phaseIdx===0 ? "hidden" : "visible";
  document.getElementById("btn-prev").disabled = phaseIdx===0;
  document.getElementById("btn-start").disabled = !!interp || pendingFinish;
  const lbl = running ? "‚è∏  Pausar" : (timeLeft<PHASES[phaseIdx].duration ? "‚ñ∂  Retomar" : "‚ñ∂  Iniciar");
  document.getElementById("btn-start").textContent = lbl;
  document.getElementById("btn-start").className = "ctrl"+(running?" running":"");
  document.getElementById("btn-interp").style.display = (!noI&&!interp&&!pendingFinish) ? "inline-block" : "none";
  document.getElementById("no-interp").style.display  = (noI && !pendingFinish) ? "block" : "none";
  // When pendingFinish, hide both interp controls ‚Äî "next phase" is the only action
  if (pendingFinish) {
    document.getElementById("btn-interp").style.display = "none";
    document.getElementById("no-interp").style.display  = "none";
  }
}

function render() {
  if (finished) {
    document.getElementById("debate-view").style.display = "none";
    document.getElementById("finished-screen").classList.add("visible");
    return;
  }
  document.getElementById("debate-view").style.display = "flex";
  const ph = PHASES[phaseIdx];
  document.getElementById("phase-label").textContent = ph.label;
  document.getElementById("phase-team").textContent  = ph.team;
  buildSidebar(); updateRing(); updateInterpDisplay(); updateButtons();
}

function startMainTicker() {
  clearInterval(mainTimer);
  mainTimer = setInterval(() => {
    if (!running || interp) return;
    timeLeft--;
    if (timeLeft <= 0) {
      timeLeft=0; clearInterval(mainTimer); running=false; done=true;
      playBuzzer();
      // Last phase: enter pendingFinish state instead of going straight to finished
      if (phaseIdx === PHASES.length - 1) {
        pendingFinish = true;
        render();
      } else {
        render();
      }
    } else { updateRing(); }
  }, 1000);
}

function startInterpTicker() {
  clearInterval(interpTimer);
  interpTimer = setInterval(() => {
    interpTime--;
    if (interpTime <= 0) {
      interpTime=0; clearInterval(interpTimer);
      if (interp==="group") {
        interp="response"; interpTime=APARTE_DUR; playBell();
        updateInterpDisplay(); startInterpTicker();
      } else {
        interp=null;
        if (timeLeft>0) { running=true; startMainTicker(); }
        render();
      }
    } else { document.getElementById("interp-digits").textContent = fmt(interpTime); }
  },1000);
}

function toggleRun() {
  if (pendingFinish) return;
  if (done && phaseIdx<PHASES.length-1) return;
  if (!running) playBell();
  running=!running;
  if (running) startMainTicker(); else clearInterval(mainTimer);
  updateButtons();
}

function goNext() {
  if (finished) { triggerApplause(); return; }

  // If we're in pendingFinish, this click is the trigger for the final screen
  if (pendingFinish) {
    pendingFinish = false;
    finished = true;
    render();
    // Small delay so the screen renders before the effects fire
    setTimeout(() => {
      playApplause();
      launchConfetti(true);
    }, 120);
    return;
  }

  clearInterval(mainTimer);
  if (phaseIdx >= PHASES.length - 1) {
    // Shouldn't normally reach here, but guard anyway
    pendingFinish = true; render(); return;
  }
  phaseIdx++; timeLeft=PHASES[phaseIdx].duration;
  running=false; done=false; interp=null;
  playBuzzer(); render();
}

function goPrev() {
  if (finished) return;
  if (phaseIdx===0) return;
  clearInterval(mainTimer);
  phaseIdx--; timeLeft=PHASES[phaseIdx].duration;
  running=false; done=false; pendingFinish=false; interp=null; render();
}

function startInterp() {
  clearInterval(mainTimer); running=false;
  interp="group"; interpTime=APARTE_DUR;
  render(); startInterpTicker();
}

function skipInterp() {
  clearInterval(interpTimer);
  if (interp==="group") {
    interp="response"; interpTime=APARTE_DUR; playBell();
    updateInterpDisplay(); startInterpTicker();
  } else {
    interp=null;
    if (timeLeft>0) { running=true; startMainTicker(); }
    render();
  }
}

function resetDebate() {
  clearInterval(mainTimer); clearInterval(interpTimer);
  phaseIdx=0; timeLeft=PHASES[0].duration;
  running=false; done=false; finished=false; pendingFinish=false; interp=null;
  document.getElementById("finished-screen").classList.remove("visible");
  render();
}

/* ‚îÄ‚îÄ Pointer/keyboard support ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener("keydown", function (e) {
  if (["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)) return;

  const ADVANCE = ["PageDown","ArrowRight","Period"," ","Enter"];
  const BACK    = ["PageUp","ArrowLeft","Escape","Backspace"];

  if (ADVANCE.includes(e.key)) {
    e.preventDefault();
    if (finished)       { triggerApplause(); return; }
    if (interp)         { skipInterp();      return; }
    if (pendingFinish)  { goNext();          return; }
    if (done)           { goNext();          return; }
    toggleRun();
    return;
  }

  if (BACK.includes(e.key)) {
    e.preventDefault();
    if (e.key === "Escape" && !finished) goPrev();
    else if (e.key !== "Escape")         goPrev();
    return;
  }

  if (e.key === "i" || e.key === "I" || e.key === "F5") {
    e.preventDefault();
    const btn = document.getElementById("btn-interp");
    if (btn && btn.style.display !== "none") startInterp();
    return;
  }
});

render();
</script>
</body>
</html>
